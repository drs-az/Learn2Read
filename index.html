<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learn2Read - Caleb</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=" />
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=" />
  <style>body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}</style>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="app"></div>

  <script type="text/babel">
    // Fry's first 100 words repeated to create a 600-word practice list
    const FRY_FIRST_100 = `the of and a to in is you that it he was for on are as with his they I at be this have from or one had by word but not what all were we when your can said there use an each which she do how their if will up other about out many then them these so some her would make like him into time has look two more write go see number no way could people my than first water been call who oil its now find long down day did get come made may part`.trim().split(/\s+/);
    const FRY_600 = Array.from({length:6}, () => FRY_FIRST_100).flat();

    function randomWord(){
      return FRY_600[Math.floor(Math.random()*FRY_600.length)];
    }

    function hideLetters(word){
      const letters = word.split('');
      const toHide = Math.max(1, Math.floor(word.length/2));
      const indexes = new Set();
      while(indexes.size < toHide){
        indexes.add(Math.floor(Math.random()*letters.length));
      }
      return letters.map((ch, i) => indexes.has(i) ? '_' : ch).join('');
    }

    function CalebClozeGame(){
      const [word, setWord] = React.useState(randomWord());
      const [mask, setMask] = React.useState(() => hideLetters(word));
      const [guess, setGuess] = React.useState('');
      const [status, setStatus] = React.useState('');

      const check = e => {
        e.preventDefault();
        if(guess.trim().toLowerCase() === word){
          setStatus('Correct!');
          const next = randomWord();
          setWord(next);
          setMask(hideLetters(next));
          setGuess('');
          setTimeout(() => setStatus(''), 1000);
        } else {
          setStatus('Try again.');
        }
      };

      return (
        <div className="p-4 max-w-md mx-auto">
          <h1 className="text-2xl font-bold mb-4 text-sky-700">Caleb's Cloze Game</h1>
          <p className="mb-2 text-lg">Guess the word: <span className="font-mono">{mask}</span></p>
          <form onSubmit={check} className="flex gap-2 mb-2">
            <input className="border rounded px-2 py-1 flex-grow" value={guess} onChange={e=>setGuess(e.target.value)} autoFocus />
            <button className="bg-sky-500 text-white px-4 rounded">Check</button>
          </form>
          {status && <p className="text-sky-600">{status}</p>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<CalebClozeGame />);
  </script>

  <script>
    (function setupPWA(){
      const ICON = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';
      // --- Manifest with inline icon data ---
      const manifest = {
        name: "Learn2Read",
        short_name: "Learn2Read",
        start_url: ".",
        display: "standalone",
        background_color: "#f1f5f9",
        theme_color: "#0ea5e9",
        icons: [
          { src: ICON, sizes: "192x192", type: "image/png", purpose: "any maskable" },
          { src: ICON, sizes: "512x512", type: "image/png", purpose: "any maskable" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
      const link = document.createElement('link'); link.rel='manifest'; link.href = URL.createObjectURL(blob); document.head.appendChild(link);

      // --- Service Worker with offline page + asset cache ---
      if('serviceWorker' in navigator){
        const swCode = `
          const CACHE = 'caleb-cloze-cache-v2';
          const OFFLINE_URL = 'offline.html';
          const CORE = [ self.location.href, OFFLINE_URL ];
          const OFFLINE_HTML = ` + "`" + `<!doctype html>
          <html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Learn2Read</title>
          <style>body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f8fafc;color:#0f172a;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:24px} .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(2,6,23,.08);max-width:520px} h1{font-size:22px;margin:0 0 8px} p{margin:0 0 12px;line-height:1.5} button{appearance:none;border:none;background:#059669;color:#fff;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer} .muted{color:#64748b;font-size:14px}</style>
          </head><body><div class="card"><h1>You're offline</h1><p>No worries — Caleb’s Cloze Game works offline once it's loaded at least once.</p><p class="muted">Reconnect and press the button below, or try again later.</p><p style="margin-top:16px"><button onclick="location.reload()">Retry</button></p></div></body></html>
          ` + "`" + `;

          self.addEventListener('install', event => {
            event.waitUntil((async()=>{
              const cache = await caches.open(CACHE);
              await cache.put(OFFLINE_URL, new Response(OFFLINE_HTML, {headers:{'Content-Type':'text/html;charset=utf-8'}}));
              try { await cache.addAll(CORE); } catch(e) {}
              await self.skipWaiting();
            })());
          });

          self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });

          self.addEventListener('fetch', event => {
            const req = event.request;
            const url = new URL(req.url);
            // App shell routing for navigations
            if (req.mode === 'navigate') {
              event.respondWith((async()=>{
                try { return await fetch(req); }
                catch { const cache = await caches.open(CACHE); return (await cache.match(OFFLINE_URL)) || Response.error(); }
              })());
              return;
            }
            // Cache-first for same-origin static assets
            if (url.origin === location.origin) {
              event.respondWith((async()=>{
                const cached = await caches.match(req);
                if (cached) return cached;
                try {
                  const resp = await fetch(req);
                  const copy = resp.clone();
                  const cache = await caches.open(CACHE);
                  cache.put(req, copy);
                  return resp;
                } catch {
                  return caches.match(OFFLINE_URL);
                }
              })());
            }
          });
        `;
        const swBlob = new Blob([swCode], {type:'text/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl);
      }
    })();
  </script>

  <!-- Offline page -->
  <script type="text/plain" id="offline-html">
    <!doctype html>
    <html><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Learn2Read</title></head>
    <body style="font-family: sans-serif; text-align: center; padding: 2rem;">
      <h1>You are offline</h1>
      <p>Caleb’s Cloze Game can still be played once reconnected or if cached.</p>
    </body></html>
  </script>
</body>
</html>
