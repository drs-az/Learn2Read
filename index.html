<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Learn2Read – Fry Words Game</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#6C63FF" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --primary:#6C63FF;
      --accent:#FFB703;
      --good:#06a77d;
      --bad:#e63946;
      --text:#222;
      --muted:#6b7280;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}

    html, body {
      height: 100%;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(70% 50% at 10% 0%, #efeaff 0%, transparent 70%),
        radial-gradient(60% 40% at 90% 10%, #ffe9c7 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      min-height:100svh;
      max-width: 100vw;         /* contain horizontally */
      overflow-x: hidden;       /* prevent side scroll */
    }

header {
  background: linear-gradient(90deg,var(--primary),#7a74ff);
  color: #fff;
  padding: calc(8px + var(--safe-top)) 16px 8px 16px;
  display: flex;
  flex-direction: column;       /* stack children vertically */
  gap: 8px;                     /* space between brand and nav */
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav {
  display: flex;
  gap: 10px;
  align-items: center;
  color: #fff;
  flex-wrap: wrap;
  justify-content: flex-start;  /* align to left under brand */
}
    .pill{
      background:rgba(255,255,255,.18);
      padding:6px 10px;border-radius:999px;font-size:13px;white-space:nowrap
    }
    .btn{
      border:0;border-radius:12px;padding:10px 16px;font-weight:700;
      background:#fff;color:var(--primary);cursor:pointer;
      box-shadow:0 8px 16px rgba(0,0,0,.08);
      transition:transform .06s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:transparent;color:#fff;border:2px solid #fff}
    .link-btn{
      background:transparent;border:none;color:var(--primary);font-weight:800;cursor:pointer;
      padding:0;text-decoration:underline;
    }

main {
  flex: 1;
  display: flex;                         /* flexbox for horizontal centering */
  justify-content: center;               /* center horizontally */
  align-items: flex-start;                /* align to top */
  padding: 32px 16px 16px;                /* extra top padding for aesthetics */
  padding-bottom: calc(16px + var(--safe-bottom));
  max-width: 100vw;
  overflow: auto;                         /* allow scroll if needed */
}

.card {
  width: min(900px, 96vw);
  background: var(--card);
  border-radius: 24px;
  padding: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,.12);
  position: relative;
  overflow: hidden;
}

.subtitle {
  color: var(--muted);
  margin: 4px 0 12px;
  font-size: 14px;
}

.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.sentence {
  font-size: 26px;
  line-height: 1.4;
  margin: 12px 0 6px;
  word-wrap: break-word;
}

.blank {
  display: inline-flex;
  gap: 6px;
  vertical-align: middle;
  margin: 0 6px;
  flex-wrap: wrap; max-width: 100%;
}

.tile {
  width: clamp(34px, 9vw, 46px);
  height: clamp(46px, 12vw, 58px);
  border-radius: 14px;
  border: 2px solid #e5e7eb;
  background: #f9fafb;
  font-size: 28px;
  text-transform: lowercase;
  text-align: center;
  font-weight: 800;
  color: #111;
  caret-color: transparent;
  outline: none;
  box-shadow: inset 0 -4px 0 #e5e7eb;
}

@media (max-width: 420px) {
  .tile {
    width: 38px;
    height: 52px;
    font-size: 24px;
  }
  .sentence {
    font-size: 22px;
  }
}

.tile:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(108,99,255,.25), inset 0 -4px 0 #e5e7eb;
}

.actions {
  margin-top: 16px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.msg {
  margin-top: 12px;
  font-weight: 700;
}

.msg.good {
  color: var(--good);
}

.msg.bad {
  color: var(--bad);
}

.progress {
  margin-top: 8px;
  color: var(--muted);
  font-size: 14px;
}

.chips {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.chip {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  background: #eef2ff;
  color: #3730a3;
}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:12px}

    .confetti{position:absolute;inset:0;pointer-events:none}

    /* Dashboard modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;z-index:50;padding:16px;
    }
    .modal{
      width:min(900px,96vw);max-height:90svh;overflow:auto;
      background:#fff;border-radius:20px;padding:20px;
      box-shadow:0 24px 64px rgba(0,0,0,.3)
    }
    .modal h2{margin:0 0 6px 0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    .badge{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 8px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="icons/icon-192.png" alt="" width="32" height="32" style="border-radius:8px;box-shadow:0 3px 8px rgba(0,0,0,.25)">
      <h1>Learn2Read</h1>
      <span class="pill">Fry Instant Words</span>
    </div>
    <div class="nav">
      <button id="newGameBtn" class="btn secondary">New Game</button>
      <button id="resetBtn" class="btn secondary" title="Clears progress & score">Reset Game</button>
      <button id="dashboardBtn" class="btn secondary" title="Parent dashboard">Dashboard</button>
      <span class="pill">✅ Correct: <b id="scoreCorrect">0</b></span>
      <span class="pill">❌ Incorrect: <b id="scoreIncorrect">0</b></span>
    </div>
  </header>

  <main>
    <div class="card" id="card">
      <canvas class="confetti" id="confetti"></canvas>

      <div class="subtitle">Fill in the missing word using letter boxes, then tap <b>Grade</b>.</div>
      <div id="sentence" class="sentence">Press <b>New Game</b> to start.</div>

      <div class="actions">
        <button id="gradeBtn" class="btn">Grade</button>
        <button id="nextBtn" class="btn" style="display:none">Next Sentence</button>
        <button id="revealBtn" class="btn" style="display:none">Show Hint</button>
      </div>

      <div class="progress" id="progress"></div>

      <!-- Reveal toggle: hidden answer chips -->
      <div style="margin-top:6px">
        <button id="revealToggle" class="link-btn" style="display:none">Reveal</button>
      </div>
      <div class="chips" id="chips" style="display:none"></div>

      <div id="message" class="msg"></div>
    </div>
  </main>

  <footer>Words: Fry Instant Words (goal: 600). Source: UEN & Dr. Edward Fry resources.</footer>

  <!-- Dashboard Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dashTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 id="dashTitle">Parent Dashboard</h2>
        <button id="closeModal" class="btn">Close</button>
      </div>
      <p class="subtitle" id="timeOnTask">Time on task: —</p>
      <h3>Per-Word Accuracy</h3>
      <table class="table" id="accuracyTable">
        <thead>
          <tr><th>Word</th><th>First-Try Correct %</th><th>Attempts</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3 style="margin-top:14px">Words to Review</h3>
      <div id="reviewList" class="chips"></div>
    </div>
  </div>

<script>
/* --- PWA bootstrap --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* --- Data: Fry Instant Words -------------------------------------------------
   Sources (for your reference):
   - UEN Fry Instant Words (ranked 1–600) – https://www.uen.org/k-2educator/word_lists.shtml
   - Dr. Edward Fry Instant Word List PDF (1–600) – by Tim Rasinski
----------------------------------------------------------------------------- */
const FRY_WORDS = [
  // First 100
  "the","of","and","a","to","in","is","you","that","it","he","was","for","on","are","as","with","his","they","I",
  "at","be","this","have","from","or","one","had","by","word","but","not","what","all","were","we","when","your","can","said",
  "there","use","an","each","which","she","do","how","their","if","will","up","other","about","out","many","then","them","these","so",
  "some","her","would","make","like","him","into","time","has","look","two","more","write","go","see","number","no","way","could","people",
  "my","than","first","water","been","call","who","oil","its","now","find","long","down","day","did","get","come","made","may","part",
  // Second 100
  "over","new","sound","take","only","little","work","know","place","year","live","me","back","give","most","very","after","thing","our","just",
  "name","good","sentence","man","think","say","great","where","help","through","much","before","line","right","too","means","old","any","same","tell",
  "boy","follow","came","want","show","also","around","form","three","small","set","put","end","does","another","well","large","must","big","even",
  "such","because","turn","here","why","ask","went","men","read","need","land","different","home","us","move","try","kind","hand","picture","again",
  // Third 100
  "change","off","play","spell","air","away","animal","house","point","page","letter","mother","answer","found","study","still","learn","should","America","world",
  "high","every","near","add","food","between","own","below","country","plant","last","school","father","keep","tree","never","start","city","earth","eye",
  "light","thought","head","under","story","saw","left","don’t","few","while","along","might","close","something","seem","next","hard","open","example","begin",
  "life","always","those","both","paper","together","got","group","often","run","important","until","children","side","feet","car","mile","night","walk","white",
  // Fourth 100
  "sea","began","grow","took","river","four","carry","state","once","book","hear","stop","without","second","late","miss","idea","enough","eat","face",
  "watch","far","Indian","real","almost","let","above","girl","sometimes","mountains","cut","young","talk","soon","list","song","being","leave","family","body",
  "music","color","stand","sun","questions","fish","area","mark","dog","horse","birds","problem","complete","room","knew","since","ever","piece","told","usually",
  "didn’t","friends","easy","heard","order","red","door","sure","become","top","ship","across","today","during","short","better","best","however","low",
  // Fifth 100
  "hours","black","products","happened","whole","measure","remember","early","waves","reached","listen","wind","rock","space","covered","fast","several","hold","himself","toward",
  "five","step","morning","passed","vowel","true","hundred","against","pattern","numeral","table","north","slowly","money","map","farm","pulled","draw","voice","seen",
  "cold","cried","plan","notice","south","sing","war","ground","fall","king","town","I’ll","unit","figure","certain","field","travel","wood","fire","upon",
  "done","English","road","half","ten","fly","gave","box","finally","wait","correct","oh","quickly","person","became","shown","minutes","strong","verb","stars",
  // Sixth 100
  "front","feel","fact","inches","street","decided","contain","course","surface","produce","building","ocean","class","note","nothing","rest","carefully","scientists","inside","wheels",
  "stay","green","known","island","week","less","machine","base","ago","stood","plane","system","behind","ran","round","boat","game","force","brought","understand",
  "warm","common","bring","explain","dry","though","language","shape","deep","thousands","yes","clear","equation","yet","government","filled","heat","full","hot","check",
  "object","am","rule","among","noun","power","cannot","able","six","size","dark","ball","material","special","heavy","fine","pair","circle","include","built",
  "can’t","matter","square","syllables","perhaps","bill","felt","suddenly","test","direction","center","farmers","ready","anything","divided","general","energy","subject","Europe","moon",
  "region","return","believe","dance","members","picked","simple","cells","paint","mind","love","cause","rain","exercise","eggs","train","blue","wish","drop","developed",
  "window","difference","distance","heart","site","sum","summer","wall","forest","probably","legs","sat","main","winter","wide","written","length","reason","kept","interest",
  "arms","brother","race","present","beautiful","store","job","edge","past","sign","record","finished","discovered","wild","happy","beside","gone","sky","million","west",
  "lay","weather","root","instruments","meet","third","months","paragraph","raised","represent"
];

/* Hand-curated starter sentences (kept; we’ll add auto-generated below) */
const CURATED = [
  {answer:"the", textBefore:"___ cat is sleeping on the mat", textAfter:"."},
  {answer:"and", textBefore:"Cookies ___ milk are on the table", textAfter:"."},
  {answer:"to", textBefore:"We walk ___ school each day", textAfter:"."},
  {answer:"in", textBefore:"Put the toy ___ the box", textAfter:"."},
  {answer:"is", textBefore:"The soup ___ hot", textAfter:"."},
  {answer:"you", textBefore:"___ are my friend", textAfter:"!"},
  {answer:"it", textBefore:"Zip up your jacket so ___ stays warm", textAfter:"."},
  {answer:"was", textBefore:"Yesterday it ___ raining", textAfter:"."},
  {answer:"on", textBefore:"Please keep both hands ___ the handlebars", textAfter:"."},
  {answer:"are", textBefore:"We ___ ready to go", textAfter:"!"},
  {answer:"with", textBefore:"I like pancakes ___ syrup", textAfter:"."},
  {answer:"they", textBefore:"___ will come to the park", textAfter:"."},
  {answer:"at", textBefore:"Meet me ___ the swings", textAfter:"."},
  {answer:"this", textBefore:"___ puzzle is tricky", textAfter:"."},
  {answer:"have", textBefore:"Do you ___ a pencil", textAfter:"?"},
  {answer:"from", textBefore:"This letter is ___ Grandma", textAfter:"."},
  {answer:"one", textBefore:"I saw ___ bright star", textAfter:"."},
  {answer:"by", textBefore:"Stand ___ the door and wave", textAfter:"."},
  {answer:"but", textBefore:"I want to play ___ it’s bedtime", textAfter:"."},
  {answer:"what", textBefore:"___ is your favorite game", textAfter:"?"},
  {answer:"all", textBefore:"We cleaned up ___ the blocks", textAfter:"."},
  {answer:"we", textBefore:"___ built a tall tower", textAfter:"!"},
  {answer:"when", textBefore:"I smile ___ I see you", textAfter:"."},
  {answer:"can", textBefore:"I ___ tie my shoes", textAfter:"."},
  {answer:"said", textBefore:"Mom ___ it’s story time", textAfter:"."},
  {answer:"there", textBefore:"Look over ___ for our seats", textAfter:"."},
  {answer:"use", textBefore:"Please ___ gentle hands", textAfter:"."},
  {answer:"which", textBefore:"___ book should we read", textAfter:"?"},
  {answer:"do", textBefore:"___ your best", textAfter:"!"},
  {answer:"how", textBefore:"___ many jumps can you do", textAfter:"?"},
  {answer:"their", textBefore:"The twins lost ___ hats", textAfter:"."},
  {answer:"if", textBefore:"___ it rains, we’ll play inside", textAfter:"."},
  {answer:"up", textBefore:"Climb ___ the ladder carefully", textAfter:"."},
  {answer:"out", textBefore:"Take the trash ___", textAfter:"."},
  {answer:"then", textBefore:"First brush, ___ rinse", textAfter:"."},
  {answer:"so", textBefore:"It’s late, ___ let’s head home", textAfter:"."},
  {answer:"her", textBefore:"She loves ___ pink backpack", textAfter:"."},
  {answer:"make", textBefore:"Let’s ___ a card for Grandpa", textAfter:"."},
  {answer:"like", textBefore:"I ___ to read before bed", textAfter:"."},
  {answer:"into", textBefore:"Step ___ the circle", textAfter:"."},
  {answer:"time", textBefore:"It’s ___ to get ready", textAfter:"."},
  {answer:"has", textBefore:"Our dog ___ a waggy tail", textAfter:"."},
  {answer:"look", textBefore:"___ both ways before crossing", textAfter:"."},
  {answer:"more", textBefore:"May I have ___ water", textAfter:"?"},
  {answer:"go", textBefore:"Ready, set, ___!", textAfter:""},
  {answer:"see", textBefore:"Can you ___ the rainbow", textAfter:"?"},
  {answer:"no", textBefore:"___ running in the hallway", textAfter:"!"},
  {answer:"way", textBefore:"This is the ___ to the library", textAfter:"."},
  {answer:"people", textBefore:"Many ___ helped clean the park", textAfter:"."},
  {answer:"my", textBefore:"___ shoes light up", textAfter:"!"},
  {answer:"first", textBefore:"Put your name ___", textAfter:"."},
  {answer:"water", textBefore:"Drink your ___ after play", textAfter:"."},
  {answer:"new", textBefore:"I got a ___ book today", textAfter:"."},
  {answer:"little", textBefore:"The ___ frog can jump high", textAfter:"."},
  {answer:"know", textBefore:"I ___ the answer", textAfter:"!"},
  {answer:"place", textBefore:"This is our favorite ___", textAfter:"."},
  {answer:"year", textBefore:"Happy New ___", textAfter:"!"},
  {answer:"very", textBefore:"You did ___ well", textAfter:"!"},
  {answer:"after", textBefore:"We’ll play ___ lunch", textAfter:"."},
  {answer:"help", textBefore:"Please ___ me zip this", textAfter:"."},
  {answer:"too", textBefore:"I want to play ___", textAfter:"!"},
  {answer:"old", textBefore:"My bike is not that ___", textAfter:"."},
  {answer:"any", textBefore:"Do you have ___ tape", textAfter:"?"},
  {answer:"tell", textBefore:"___ me your idea", textAfter:"."},
  {answer:"boy", textBefore:"The ___ kicks the ball", textAfter:"."},
  {answer:"came", textBefore:"Grandpa ___ to visit", textAfter:"."},
  {answer:"want", textBefore:"I ___ to try again", textAfter:"."},
  {answer:"also", textBefore:"I like apples and bananas ___", textAfter:"."},
  {answer:"three", textBefore:"We have ___ cookies", textAfter:"."},
  {answer:"does", textBefore:"What ___ the sign say", textAfter:"?"},
  {answer:"well", textBefore:"You read that very ___", textAfter:"!"},
  {answer:"here", textBefore:"Come sit right ___", textAfter:"."},
  {answer:"why", textBefore:"___ is the sky blue", textAfter:"?"},
  {answer:"ask", textBefore:"___ a question kindly", textAfter:"."},
  {answer:"read", textBefore:"Let’s ___ one more page", textAfter:"."},
  {answer:"need", textBefore:"Do you ___ a snack", textAfter:"?"},
  {answer:"home", textBefore:"We are going ___ now", textAfter:"."},
  {answer:"try", textBefore:"It’s okay—just ___ again", textAfter:"."},
  {answer:"again", textBefore:"Wow! Do that trick ___", textAfter:"!"},
  {answer:"run", textBefore:"Don’t ___ by the pool", textAfter:"."},
  {answer:"children", textBefore:"All the ___ lined up", textAfter:"."},
  {answer:"car", textBefore:"Buckle your seat in the ___", textAfter:"."},
  {answer:"night", textBefore:"Good ___, sleep tight", textAfter:"."},
  {answer:"walk", textBefore:"Let’s ___ the dog", textAfter:"."},
  {answer:"white", textBefore:"Snow looks so ___", textAfter:"."}
];

/* ========= Natural Language Cloze Generator (POS-aware) ========= */

/* 1) Categorize common FUNCTION WORDS (covers most awkward cases) */
const CAT = {
  ARTICLE: 'article',
  DEMONSTRATIVE: 'demonstrative',
  DETERMINER: 'determiner',
  PRONOUN_SUBJ: 'pronounSubj',
  PRONOUN_OBJ: 'pronounObj',
  POSSESSIVE: 'possessive',
  PREPOSITION: 'preposition',
  BE_LINK: 'beLink',
  DO_AUX: 'doAux',
  MODAL: 'modal',
  CONJ: 'conjunction',
  WH: 'wh',
  ADVERB: 'adverb',
  NEGATION: 'negation',
  NUMBER: 'number',
  NOUN: 'noun',
  VERB: 'verb',
  ADJ: 'adjective',
  META: 'meta',         // generic "read/write/say the word ___" style
};

const SETS = {
  article: new Set(['the','a','an']),
  demonstrative: new Set(['this','that','these','those']),
  determiner: new Set(['some','any','each','every','no','both','another','other','many','few','several','more','most','such','own','same','another']),
  pronounSubj: new Set(['i','you','he','she','it','we','they']),
  pronounObj: new Set(['me','him','her','us','them']),
  possessive: new Set(['my','your','his','her','its','our','their']),
  preposition: new Set(['in','on','at','by','with','from','into','over','under','between','through','after','before','around','above','below','near','off','up','out','across','during','toward','to']),
  beLink: new Set(['am','is','are','was','were']),
  doAux: new Set(['do','does','did']),
  modal: new Set(['can','will','would','could','should','may','might','must','shall']),
  conjunction: new Set(['and','but','or','so','because','if','when','while','though','until','after','before']),
  wh: new Set(['what','when','where','why','how','which','who','whom','whose']),
  adverb: new Set(['very','too','also','just','now','then','so','not','only','even','still','again','always','often','never']),
  negation: new Set(['no',"don't","didn’t","didn't","can’t","cant","cannot","won’t","wouldn’t","shouldn’t"]),
  number: new Set(['one','two','three','four','five','six','seven','eight','nine','ten','hundred','thousand'])
};
/* Specialized content-word lists (subset of Fry words) */
const FRY_NOUNS = new Set([
  'river','water','school','father','mother','city','earth','tree','story','paper','car',
  'night','day','hand','home','boy','girl','door','table','room','book','dog','horse',
  'birds','music','color','sun','fish','area','mark','problem','family','body','friend',
  'children','group','world','america','country','plant','page','letter','point'
]);
const FRY_VERBS = new Set([
  'run','walk','play','read','write','make','see','look','come','go','get','find','start',
  'keep','learn','spell','help','show','tell','try','move','ask','follow','carry','grow',
  'took','took','took','bring','gave','wait','open','close','change'
]);
const FRY_ADJECTIVES = new Set([
  'big','small','little','new','old','good','great','high','long','short','white','black',
  'red','best','better','early','fast','low','real','young','happy'
]);


/* 2) Kid-friendly TEMPLATES for each category.
      Each string contains "___" where the missing word goes. */
const TEMPLATES = {
  [CAT.NOUN]: [
    'The ___ is big.',
    'I saw the ___ today.',
    'We crossed the ___.',
    'The ___ is on the map.',
    'Please draw the ___.'
  ],
  [CAT.VERB]: [
    'I like to ___ fast.',
    'We will ___ to the park.',
    'Can you ___ with me?',
    'Please ___ your name.',
    'Do not ___ in the hall.'
  ],
  [CAT.ADJ]: [
    'The house is ___.',
    'This is a ___ book.',
    'We had a ___ day.',
    'That is a ___ idea.',
    'The road is ___ and safe.'
  ],
[CAT.ARTICLE]: [
    "___ dog ran fast.",
    "I saw ___ bird in the tree.",
    "Please hand me ___ book."
  ],
  [CAT.DEMONSTRATIVE]: [
    "___ cookie is for you.",
    "Put ___ toys in the bin.",
    "I like ___ game a lot."
  ],
  [CAT.DETERMINER]: [
    "I have ___ stickers to share.",
    "Are there ___ crayons left?",
    "We need ___ help today."
  ],
  [CAT.PRONOUN_SUBJ]: [
    "___ like to play outside.",
    "___ is my best friend.",
    "Can ___ come with us?"
  ],
  [CAT.PRONOUN_OBJ]: [
    "Mom helped ___ tie my shoes.",
    "I saw ___ at the park.",
    "Please give the ball to ___."
  ],
  [CAT.POSSESSIVE]: [
    "That is ___ backpack.",
    "___ teacher is very kind.",
    "I forgot ___ homework."
  ],
  [CAT.PREPOSITION]: [
    "The ball is ___ the box.",
    "We hide ___ the table.",
    "The cat sleeps ___ my bed."
  ],
  [CAT.BE_LINK]: [
    "The soup ___ hot.",
    "We ___ ready to go.",
    "My name ___ Sam."
  ],
  [CAT.DO_AUX]: [
    "___ you want to read?",
    "___ he like apples?",
    "We ___ our chores."
  ],
  [CAT.MODAL]: [
    "I ___ ride my bike.",
    "She ___ help you.",
    "We ___ play after lunch."
  ],
  [CAT.CONJ]: [
    "I like cats ___ dogs.",
    "It is sunny ___ warm.",
    "We stayed inside ___ it rained."
  ],
  [CAT.WH]: [
    "___ is your favorite book?",
    "___ do we go to class?",
    "___ should we try next?"
  ],
  [CAT.ADVERB]: [
    "You read ___ well.",
    "He ran ___ fast.",
    "She is ___ happy today."
  ],
  [CAT.NEGATION]: [
    "___ running in the hall!",
    "I ___ know the answer.",
    "We ___ have time."
  ],
  [CAT.NUMBER]: [
    "We have ___ apples.",
    "Write the number ___.",
    "Count to ___ together."
  ],
  [CAT.META]: [
    "Can you read ___ out loud?",
    "Please write the word ___.",
    "Point to ___ in your book.",
    "Use ___ in a sentence.",
    "Spell ___ with letter tiles."
  ]
};

/* 3) Categorizer: maps a word to its best-fit category for early reading */
function categorizeWord(raw) {
  const w = raw.toLowerCase();
    if (FRY_NOUNS.has(w)) return CAT.NOUN;
  if (FRY_VERBS.has(w)) return CAT.VERB;
  if (FRY_ADJECTIVES.has(w)) return CAT.ADJ;
if (SETS.article.has(w)) return CAT.ARTICLE;
  if (SETS.demonstrative.has(w)) return CAT.DEMONSTRATIVE;
  if (SETS.determiner.has(w)) return CAT.DETERMINER;
  if (SETS.pronounSubj.has(w)) return CAT.PRONOUN_SUBJ;
  if (SETS.pronounObj.has(w)) return CAT.PRONOUN_OBJ;
  if (SETS.possessive.has(w)) return CAT.POSSESSIVE;
  if (SETS.preposition.has(w)) return CAT.PREPOSITION;
  if (SETS.beLink.has(w)) return CAT.BE_LINK;
  if (SETS.doAux.has(w)) return CAT.DO_AUX;
  if (SETS.modal.has(w)) return CAT.MODAL;
  if (SETS.conjunction.has(w)) return CAT.CONJ;
  if (SETS.wh.has(w)) return CAT.WH;
  if (SETS.adverb.has(w)) return CAT.ADVERB;
  if (SETS.negation.has(w)) return CAT.NEGATION;
  if (SETS.number.has(w)) return CAT.NUMBER;
  return CAT.META; // safe default that always sounds natural
}

/* 4) Build a single logical sentence for a given word */
function buildSentenceFor(word) {
  const cat = categorizeWord(word);
  const list = TEMPLATES[cat] || TEMPLATES[CAT.META];
  const template = list[Math.floor(Math.random() * list.length)];
  const [before, after=''] = template.split('___');
  return { answer: word.toLowerCase(), textBefore: before.trim(), textAfter: after.trim() };
}

/* 5) Build a large deck: curated + N auto-generated (all logical) */
function buildAutoDeck(n = 300) {
  const used = new Set(CURATED.map(s => s.answer.toLowerCase()));
  const autos = [];
  const pool = [...FRY_WORDS].sort(() => Math.random() - 0.5); // shuffle

  for (const w of pool) {
    const wl = w.toLowerCase();
    if (used.has(wl)) continue;
    const s = buildSentenceFor(wl);
    if (s && s.textBefore && (s.textBefore.length + (s.textAfter||'').length) >= 8) {
      autos.push(s);
      used.add(wl);
    }
    if (autos.length >= n) break;
  }
  return autos;
}

/* 6) Rebuild the SENTENCES deck using curated + logical autos */
const SENTENCES = [...CURATED, ...buildAutoDeck(300)];

/* ---------------- State & Storage ------------------ */
const LS_STATE = 'l2r_state_v2';
const LS_METRIC = 'l2r_metrics_v1';

let order = [];           // shuffled indexes for SENTENCES
let idx = 0;              // current position
let scoreCorrect = 0;
let scoreIncorrect = 0;
let countedThisCard = false;

const metrics = loadMetrics(); // { startedAt, totalMs, words:{[word]:{attempts, firstWrong, firstTryCorrect}} , review:Set }
let sessionStart = Date.now();

/* Elements */
const $sentence = document.getElementById('sentence');
const $message  = document.getElementById('message');
const $progress = document.getElementById('progress');
const $chips    = document.getElementById('chips');
const $grade    = document.getElementById('gradeBtn');
const $next     = document.getElementById('nextBtn');
const $reveal   = document.getElementById('revealBtn');
const $reset    = document.getElementById('resetBtn');
const $newGame  = document.getElementById('newGameBtn');
const $scC      = document.getElementById('scoreCorrect');
const $scI      = document.getElementById('scoreIncorrect');
const $confetti = document.getElementById('confetti');
const $revealToggle = document.getElementById('revealToggle');
const $dashboardBtn = document.getElementById('dashboardBtn');
const $modalBackdrop = document.getElementById('modalBackdrop');
const $closeModal = document.getElementById('closeModal');
const $timeOnTask = document.getElementById('timeOnTask');
const $accTableBody = document.querySelector('#accuracyTable tbody');
const $reviewList = document.getElementById('reviewList');

/* Utils */
const shuffle = a => { for (let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; };
function save(){
  localStorage.setItem(LS_STATE, JSON.stringify({order, idx, scoreCorrect, scoreIncorrect}));
  saveMetrics();
}
function load(){
  const raw = localStorage.getItem(LS_STATE);
  if(!raw) return false;
  try{
    const s = JSON.parse(raw);
    if(!Array.isArray(s.order) || typeof s.idx!=='number') return false;
    order = s.order; idx = s.idx; scoreCorrect = s.scoreCorrect||0; scoreIncorrect = s.scoreIncorrect||0;
    return true;
  }catch{ return false; }
}
function resetAll(){
  order = shuffle([...Array(SENTENCES.length).keys()]);
  idx = 0; scoreCorrect = 0; scoreIncorrect = 0;
  save();
}

/* Metrics */
function loadMetrics(){
  const raw = localStorage.getItem(LS_METRIC);
  if(!raw){
    return { startedAt: Date.now(), totalMs: 0, words:{}, review:{} };
  }
  try{
    const m = JSON.parse(raw);
    if (!m.words) m.words = {};
    if (!m.review) m.review = {};
    if (!m.startedAt) m.startedAt = Date.now();
    if (typeof m.totalMs !== 'number') m.totalMs = 0;
    return m;
  } catch {
    return { startedAt: Date.now(), totalMs: 0, words:{}, review:{} };
  }
}
function saveMetrics(){
  localStorage.setItem(LS_METRIC, JSON.stringify(metrics));
}
function addTime(){
  const now = Date.now();
  metrics.totalMs += (now - sessionStart);
  sessionStart = now;
  saveMetrics();
}
window.addEventListener('beforeunload', addTime);

/* Confetti */
const confetti = (() => {
  const cv = $confetti;
  const ctx = cv.getContext('2d');
  let parts = [], timer;
  const resize = () => { cv.width = cv.clientWidth; cv.height = cv.clientHeight; };
  window.addEventListener('resize', resize); resize();
  function burst(){
    parts = Array.from({length:60}).map(() => ({
      x: cv.width/2, y: cv.height/3, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2,
      r: Math.random()*3+2, a:1, vr: (Math.random()-0.5)*0.2
    }));
    if(timer) cancelAnimationFrame(timer);
    loop();
  }
  function loop(){
    ctx.clearRect(0,0,cv.width,cv.height);
    parts.forEach(p=>{
      p.vy += 0.15; p.x += p.vx; p.y += p.vy; p.a -= 0.01; p.r += p.vr;
      ctx.globalAlpha = Math.max(p.a,0);
      ctx.beginPath(); ctx.arc(p.x,p.y,Math.max(p.r,0),0,Math.PI*2); ctx.fillStyle = '#'+(~~(Math.random()*0xFFFFFF)).toString(16).padStart(6,'0'); ctx.fill();
    });
    parts = parts.filter(p=>p.a>0 && p.y < cv.height+20);
    if(parts.length) timer = requestAnimationFrame(loop);
  }
  return { burst };
})();

/* Render */
function renderCard(){
  $message.textContent = '';
  $message.className = 'msg';
  $next.style.display = 'none';
  $reveal.style.display = 'inline-block';
  countedThisCard = false;

  // reveal chips reset
  $chips.style.display = 'none';
  $revealToggle.style.display = 'inline';
  $revealToggle.textContent = 'Reveal';

  if(idx >= order.length){
    $sentence.innerHTML = `🎉 All done! You finished ${order.length} sentences. Press <b>New Game</b> to play again.`;
    $progress.textContent = '';
    $chips.innerHTML='';
    $revealToggle.style.display = 'none';
    return;
  }

  const s = SENTENCES[order[idx]];
  const answer = s.answer.toLowerCase();
  const letters = [...answer];

  // Build letter tiles
  const blank = document.createElement('span'); blank.className = 'blank';
  blank.setAttribute('role','group'); blank.setAttribute('aria-label','Type the missing word');
  letters.forEach((_,i)=>{
    const input = document.createElement('input');
    input.className = 'tile';
    input.maxLength = 1;
    input.inputMode = 'latin';
    input.autocapitalize = 'none';
    input.autocomplete = 'off';
    input.spellcheck = 'false';
    input.dataset.idx = i;
    input.addEventListener('input', (e)=>{
      e.target.value = e.target.value.replace(/[^a-zA-Z’']/g,'').toLowerCase();
      const next = e.target.nextElementSibling;
      if(e.target.value && next) next.focus();
    });
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Backspace' && !e.target.value){
        const prev = e.target.previousElementSibling; if(prev){prev.focus(); prev.value='';}
      }
      if(e.key==='ArrowLeft'){ const prev = e.target.previousElementSibling; if(prev) prev.focus(); }
      if(e.key==='ArrowRight'){ const next = e.target.nextElementSibling; if(next) next.focus(); }
      if(e.key==='Enter'){ grade(); }
    });
    blank.appendChild(input);
  });

  $sentence.innerHTML='';
  const pre = document.createTextNode(capitalIfNeeded(s.textBefore) + ' ');
  const post = document.createTextNode((s.textAfter||''));
  $sentence.appendChild(pre);
  $sentence.appendChild(blank);
  $sentence.appendChild(document.createTextNode(' '));
  $sentence.appendChild(post);

  $progress.textContent = `Card ${idx+1} of ${order.length}`;

  $chips.innerHTML = '';
  $chips.appendChild(chip(`Target word: ${answer}`));
  $chips.appendChild(chip(`Letters: ${letters.length}`));

  const first = blank.querySelector('.tile'); if(first) first.focus();

  $scC.textContent = String(scoreCorrect);
  $scI.textContent = String(scoreIncorrect);
  save();
}

function capitalIfNeeded(text){
  if(!text) return '';
  const t = text.trimStart();
  const cap = t.charAt(0).toUpperCase() + t.slice(1);
  return text.replace(t, cap);
}
function chip(text){
  const el = document.createElement('span');
  el.className = 'chip';
  el.textContent = text;
  return el;
}
function getTypedWord(){
  const tiles = [...document.querySelectorAll('.tile')];
  return tiles.map(t=>t.value.toLowerCase()).join('');
}

/* Grade logic with metrics */
function ensureWordMetric(word){
  if(!metrics.words[word]) metrics.words[word] = { attempts:0, firstWrong:0, firstTryCorrect:0 };
}
function grade(){
  if(idx >= order.length) return;
  const s = SENTENCES[order[idx]];
  const answer = s.answer.toLowerCase();
  const typed = getTypedWord();

  ensureWordMetric(answer);

  if(!typed || typed.length !== answer.length){
    $message.textContent = 'Keep going — fill all the boxes first.';
    $message.className = 'msg';
    return;
  }

  // Count attempt for metrics (first click on Grade per card is an attempt)
  if (metrics.words[answer]._countedAttemptForIdx !== idx) {
    metrics.words[answer].attempts += 1;
    metrics.words[answer]._countedAttemptForIdx = idx;
  }

  if(typed === answer){
    $message.textContent = '✅ Correct! Great job!';
    $message.className = 'msg good';
    // If this was the first attempt for this card, mark firstTryCorrect
    if (!countedThisCard) {
      metrics.words[answer].firstTryCorrect += 1;
    }
    scoreCorrect += 1;
    $scC.textContent = String(scoreCorrect);
    $next.style.display = 'inline-block';
    $reveal.style.display = 'none';
    confetti.burst();
    saveMetrics();
    save();
  } else {
    $message.textContent = '❌ Not quite. Try again!';
    $message.className = 'msg bad';
    if(!countedThisCard){
      scoreIncorrect += 1;
      countedThisCard = true;
      $scI.textContent = String(scoreIncorrect);
      metrics.words[answer].firstWrong += 1;
      metrics.review[answer] = true;   // add to review set
      saveMetrics();
      save();
    }
  }
}

/* Hint */
function revealHint(){
  if(idx >= order.length) return;
  const s = SENTENCES[order[idx]];
  const letters = [...s.answer.toLowerCase()];
  const tiles = [...document.querySelectorAll('.tile')];
  for(let i=0;i<tiles.length;i++){
    if(!tiles[i].value || tiles[i].value !== letters[i]){
      tiles[i].value = letters[i];
      tiles[i].focus();
      break;
    }
  }
}

/* Next */
function nextCard(){
  if(idx < order.length){ idx += 1; }
  renderCard();
}

/* Reveal toggle */
$revealToggle.addEventListener('click', ()=>{
  if ($chips.style.display === 'none'){
    $chips.style.display = 'flex';
    $revealToggle.textContent = 'Hide';
  } else {
    $chips.style.display = 'none';
    $revealToggle.textContent = 'Reveal';
  }
});

/* New Game & Reset */
document.getElementById('newGameBtn').addEventListener('click', () => { resetAll(); renderCard(); });
document.getElementById('resetBtn').addEventListener('click', () => {
  if(confirm('Reset game and clear your saved progress, scores, and metrics?')){
    localStorage.removeItem(LS_STATE);
    localStorage.removeItem(LS_METRIC);
    Object.assign(metrics, { startedAt: Date.now(), totalMs: 0, words:{}, review:{} });
    resetAll(); renderCard();
  }
});

/* Buttons */
$grade.addEventListener('click', grade);
$next.addEventListener('click', nextCard);
$reveal.addEventListener('click', revealHint);

/* Dashboard */
$dashboardBtn.addEventListener('click', openDashboard);
$closeModal.addEventListener('click', closeDashboard);
$modalBackdrop.addEventListener('click', (e)=>{ if(e.target === $modalBackdrop) closeDashboard(); });

function openDashboard(){
  addTime(); // flush time so far into totalMs
  // Time on task
  const mins = Math.round(metrics.totalMs / 60000);
  $timeOnTask.textContent = `Time on task: ${mins} minute${mins===1?'':'s'}`;

  // Build accuracy rows
  const entries = Object.entries(metrics.words)
    .filter(([w,obj]) => !w.startsWith('_')) // skip internal flags
    .map(([w,obj]) => {
      const attempts = obj.attempts || 0;
      const firstTry = obj.firstTryCorrect || 0;
      const pct = attempts ? Math.round((firstTry/attempts)*100) : 0;
      return {word:w, attempts, pct};
    })
    .sort((a,b)=> a.word.localeCompare(b.word));

  $accTableBody.innerHTML = entries.map(r =>
    `<tr><td>${r.word}</td><td>${r.pct}%</td><td>${r.attempts}</td></tr>`
  ).join('') || `<tr><td colspan="3">Play a bit to see stats.</td></tr>`;

  // Review chips
  const reviewWords = Object.keys(metrics.review||{}).sort();
  $reviewList.innerHTML = reviewWords.length
    ? reviewWords.map(w=>`<span class="chip">${w}</span>`).join('')
    : '<span class="badge">No words to review yet 🎉</span>';

  $modalBackdrop.style.display = 'flex';
  $modalBackdrop.setAttribute('aria-hidden','false');
}
function closeDashboard(){
  $modalBackdrop.style.display = 'none';
  $modalBackdrop.setAttribute('aria-hidden','true');
}

/* Resume or start fresh */
if(!load()){ resetAll(); }
renderCard();
</script>
</body>
</html>
